<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Inventario & GestiÃ³n de MercaderÃ­a</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background:#728abb; padding:2rem; }
    .card { margin-bottom:2rem; border-radius:15px; box-shadow:0 0 10px rgba(0,0,0,0.3); }
    .edit-btn,.delete-btn{visibility:hidden;}
  </style>
</head>
<body>

  <!-- 1) INVENTARIO -->
  <div class="container card bg-white p-4">
    <h3>ðŸ“¦ Inventario</h3>
    <form id="formInventario" class="row g-3 mb-4">
      <div class="col-md-2"><input type="text" id="itemInv" class="form-control" placeholder="Item" required></div>
      <div class="col-md-2"><input type="text" id="codigoInv" class="form-control" placeholder="CÃ³digo" required></div>
      <div class="col-md-4"><input type="text" id="nombreInv" class="form-control" placeholder="Nombre" required></div>
      <div class="col-md-2"><input type="number" id="unidadesInv" class="form-control" placeholder="Unidades" required></div>
      <div class="col-md-2"><button type="submit" class="btn btn-primary w-100">Agregar Inventario</button></div>
    </form>

    <div class="table-responsive">
      <table class="table table-striped table-bordered text-center">
        <thead class="table-dark">
          <tr>
            <th>Item</th><th>CÃ³digo</th><th>Nombre</th>
            <th>Ingreso</th><th>Egreso</th><th>Unidades</th><th>Acciones</th>
          </tr>
        </thead>
        <tbody id="inventarioBody"></tbody>
      </table>
    </div>
  </div>

  <!-- 2) GESTIÃ“N DE MERCADERÃA -->
  <div class="container card bg-white p-4">
    <h3>ðŸ“Š GestiÃ³n de MercaderÃ­a</h3>
    <form id="formGestion" class="row g-3 mb-4">
      <div class="col-md-3"><select id="selProducto" class="form-select" required>
        <option value="" disabled selected>Selecciona Nombre</option>
      </select></div>
      <div class="col-md-2"><input type="number" id="ingresoG" class="form-control" placeholder="Ingreso" readonly></div>
      <div class="col-md-2"><input type="number" step="0.01" id="precioCompraG" class="form-control" placeholder="Costo" required></div>
      <div class="col-md-1"><input type="number" id="ventaG" class="form-control" placeholder="Venta" required></div>
      <div class="col-md-2"><input type="number" step="0.01" id="precioVentaG" class="form-control" placeholder="Precio Venta" required></div>
      <div class="col-md-1"><input type="number" id="saldoG" class="form-control" placeholder="Saldo" readonly></div>
      <div class="col-md-1"><button type="submit" class="btn btn-success w-100">+ AÃ±adir</button></div>
    </form>

    <div class="table-responsive">
      <table class="table table-striped table-bordered text-center">
        <thead class="table-dark">
          <tr>
            <th>#</th><th>Producto</th><th>Ingreso</th><th>Costo</th>
            <th>Venta</th><th>Precio Venta</th><th>Saldo</th>
            <th>Val.1<br><small>IngresoÃ—Venta</small></th>
            <th>Val.2<br><small>PrecioVentaÃ—Saldo</small></th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody id="gestionBody"></tbody>
      </table>
    </div>
  </div>

  <!-- Bootstrap + Script -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const MASTER_PWD = 'fernandez';

    // Datos en localStorage
    let inventario = JSON.parse(localStorage.getItem('inventario')) || [];
    let gestion     = JSON.parse(localStorage.getItem('gestion'))     || [];
    const ingresos  = JSON.parse(localStorage.getItem('mg_balance_ingresos') || '{}');
    const egresos   = JSON.parse(localStorage.getItem('mg_balance_egresos')  || '{}');

    // 1) Inventario
    function saveInv(){ localStorage.setItem('inventario', JSON.stringify(inventario)); }
    function renderInv(){
      const t = document.getElementById('inventarioBody');
      t.innerHTML = '';
      inventario.forEach((v,i)=>{
        t.insertAdjacentHTML('beforeend',`
          <tr>
            <td>${v.item}</td><td>${v.codigo}</td><td>${v.nombre}</td>
            <td>${ingresos[v.nombre.toUpperCase()]||0}</td>
            <td>${egresos[v.nombre.toUpperCase()]||0}</td>
            <td>${v.unidades}</td>
            <td>
              <button class="btn btn-sm btn-warning edit-btn" onclick="editInv(${i})">âœŽ</button>
              <button class="btn btn-sm btn-danger  delete-btn" onclick="delInv(${i})">ðŸ—‘</button>
            </td>
          </tr>`);
      });
      refreshSelect();
    }
    document.getElementById('formInventario').onsubmit = e=>{
      e.preventDefault();
      inventario.push({
        item:document.getElementById('itemInv').value,
        codigo:document.getElementById('codigoInv').value,
        nombre:document.getElementById('nombreInv').value.trim(),
        unidades:parseInt(document.getElementById('unidadesInv').value,10)
      });
      saveInv(); renderInv();
      e.target.reset();
    };
    function delInv(i){ inventario.splice(i,1); saveInv(); renderInv(); }
    function editInv(i){
      const v = inventario.splice(i,1)[0];
      ['itemInv','codigoInv','nombreInv','unidadesInv'].forEach(id=>{
        document.getElementById(id).value = v[id.replace('Inv','')];
      });
      saveInv(); renderInv();
    }

    // 2) GestiÃ³n
    function saveGes(){ localStorage.setItem('gestion', JSON.stringify(gestion)); }
    function refreshSelect(){
      const sel=document.getElementById('selProducto');
      sel.innerHTML = '<option value="" disabled selected>Selecciona Nombre</option>';
      inventario.forEach(v=> sel.innerHTML+=`<option>${v.nombre}</option>`);
    }
    document.getElementById('selProducto').onchange = e=>{
      const nom = e.target.value;
      document.getElementById('ingresoG').value     = ingresos[nom.toUpperCase()]||0;
      document.getElementById('saldoG').value       =
        (inventario.find(x=>x.nombre===nom)||{}).unidades||0;
    };
    function renderGes(){
      const t = document.getElementById('gestionBody');
      t.innerHTML='';
      gestion.forEach((p,i)=>{
        const v1=p.ingreso*p.venta, v2=p.precioVenta*p.saldo;
        t.insertAdjacentHTML('beforeend',`
          <tr>
            <td>${i+1}</td><td>${p.producto}</td>
            <td>${p.ingreso}</td>
            <td>S/ ${p.precioCompra.toFixed(2)}</td>
            <td>${p.venta}</td>
            <td>S/ ${p.precioVenta.toFixed(2)}</td>
            <td>${p.saldo}</td>
            <td>${v1}</td>
            <td>S/ ${v2.toFixed(2)}</td>
            <td>
              <button class="btn btn-sm btn-warning edit-btn" onclick="editGes(${i})">âœŽ</button>
              <button class="btn btn-sm btn-danger  delete-btn" onclick="delGes(${i})">ðŸ—‘</button>
            </td>
          </tr>`);
      });
    }
    document.getElementById('formGestion').onsubmit = e=>{
      e.preventDefault();
      const nom = document.getElementById('selProducto').value;
      const inv = inventario.find(x=>x.nombre===nom);
      const p = {
        producto:     nom,
        ingreso:      parseInt(document.getElementById('ingresoG').value,10),
        precioCompra: parseFloat(document.getElementById('precioCompraG').value),
        venta:        parseInt(document.getElementById('ventaG').value,10),
        precioVenta:  parseFloat(document.getElementById('precioVentaG').value),
        saldo:        inv.unidades
      };
      gestion.push(p);
      saveGes(); renderGes();
      e.target.reset();
    };
    function delGes(i){ gestion.splice(i,1); saveGes(); renderGes(); }
    function editGes(i){
      const p = gestion.splice(i,1)[0];
      document.getElementById('selProducto').value      = p.producto;
      document.getElementById('ingresoG').value         = p.ingreso;
      document.getElementById('precioCompraG').value    = p.precioCompra;
      document.getElementById('ventaG').value           = p.venta;
      document.getElementById('precioVentaG').value     = p.precioVenta;
      document.getElementById('saldoG').value           = p.saldo;
      saveGes(); renderGes();
    }

    // Desbloquear ediciÃ³n general
    function unlockEditing(){
      const ok = document.getElementById('masterPassword').value===MASTER_PWD;
      document.querySelectorAll('.edit-btn,.delete-btn')
              .forEach(b=>b.style.visibility=ok?'visible':'hidden');
      alert(ok?'EdiciÃ³n habilitada':'ContraseÃ±a incorrecta');
    }

    // Inicial
    renderInv(); renderGes();
  </script>
</body>
</html>
