 <!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Gesti√≥n y Registro de Mercader√≠a</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background-color: #728abb; padding: 2rem; }
    .card { margin-bottom: 2rem; border-radius: 15px; box-shadow: 0 0 10px rgba(0,0,0,0.3); }
    .edit-btn, .delete-btn { visibility: hidden; }
  </style>
</head>
<body>

  <!-- Desbloquear edici√≥n -->
  <div class="container mb-4">
    <h2 class="text-white">üîê Desbloquear Edici√≥n</h2>
    <div class="input-group">
      <input type="password" id="masterPassword" class="form-control" placeholder="Contrase√±a maestra">
      <button class="btn btn-outline-light" onclick="unlockEditing()">Validar</button>
    </div>
  </div>

  <!-- 1) GESTI√ìN DE MERCADER√çA -->
  <div class="container card bg-white p-4">
    <h3>üì¶ Gesti√≥n de Mercader√≠a</h3>
    <form id="formGestion" class="row g-3 mb-4">
      <div class="col-md-3">
        <input type="text" class="form-control" id="producto" placeholder="Producto" required>
      </div>
      <div class="col-md-2">
        <input type="number" class="form-control" id="ingreso" placeholder="Ingreso" readonly>
      </div>
      <div class="col-md-2">
        <input type="number" step="0.01" class="form-control" id="precioCompra" placeholder="Costo" required>
      </div>
      <div class="col-md-1">
        <input type="number" class="form-control" id="venta" placeholder="Venta" required>
      </div>
      <div class="col-md-2">
        <input type="number" step="0.01" class="form-control" id="precioVenta" placeholder="Precio Venta" required>
      </div>
      <div class="col-md-1">
        <input type="number" class="form-control" id="saldo" placeholder="Saldo" required>
      </div>
      <div class="col-md-1">
        <button type="submit" class="btn btn-success w-100">+ Agregar</button>
      </div>
    </form>

    <div class="table-responsive">
      <table class="table table-striped table-bordered text-center">
        <thead class="table-dark">
          <tr>
            <th>#</th><th>Producto</th><th>Ingreso</th><th>Costo</th>
            <th>Venta</th><th>Precio Venta</th><th>Saldo</th>
            <th>Val.1<br><small>Ingreso√óVenta</small></th>
            <th>Val.2<br><small>PrecioVenta√óSaldo</small></th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody id="gestionBody"></tbody>
      </table>
    </div>
  </div>

  <!-- 2) REGISTRO DE VENTAS -->
  <div class="container card bg-white p-4">
    <h3>üìù Registro de Ventas</h3>
    <form id="formRegistro" class="row g-3 mb-4">
      <div class="col-md-2">
        <input type="text" id="itemVenta" class="form-control" placeholder="Item" required>
      </div>
      <div class="col-md-2">
        <input type="text" id="codigoVenta" class="form-control" placeholder="C√≥digo" required>
      </div>
      <div class="col-md-2">
        <input type="text" id="nombreVenta" class="form-control" placeholder="Nombre" required>
      </div>
      <div class="col-md-2">
        <input type="number" id="unidadesVendidas" class="form-control" placeholder="Unidades" required>
      </div>
      <div class="col-md-2">
        <button type="submit" class="btn btn-primary w-100">Registrar Venta</button>
      </div>
    </form>

    <div class="table-responsive">
      <table class="table table-striped table-bordered text-center">
        <thead class="table-dark">
          <tr>
            <th>Item</th><th>C√≥digo</th><th>Nombre</th>
            <th>Ingreso</th><th>Egreso</th><th>Unidades</th><th>Acciones</th>
          </tr>
        </thead>
        <tbody id="registroBody"></tbody>
      </table>
    </div>
  </div>

  <!-- Modal de alerta (saldo bajo) -->
  <div class="modal fade" id="alertaModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content border-warning">
        <div class="modal-header bg-warning text-dark">
          <h5 class="modal-title">‚ö†Ô∏è Stock Bajo</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          El producto <strong id="nombreProductoAlerta"></strong> tiene <strong>saldo bajo</strong> (‚â§ 5 unidades).<br>
          üí° Se recomienda comprar m√°s y subirle S/5 al precio de venta.
        </div>
        <div class="modal-footer">
          <button class="btn btn-outline-warning" data-bs-dismiss="modal">Entendido</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS y l√≥gica -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const MASTER_PWD = 'fernandez';

    // Arrays persistentes
    let productos = JSON.parse(localStorage.getItem('productos')) || [];
    let ventas     = JSON.parse(localStorage.getItem('ventas'))    || [];

    // Ingresos y egresos desde balance.html
    const ingresosBalance = JSON.parse(localStorage.getItem('mg_balance_ingresos') || '{}');
    const egresosBalance  = JSON.parse(localStorage.getItem('mg_balance_egresos')  || '{}');

    // Desbloquear edici√≥n
    function unlockEditing() {
      const ok = document.getElementById('masterPassword').value === MASTER_PWD;
      document.querySelectorAll('.edit-btn, .delete-btn')
              .forEach(b => b.style.visibility = ok ? 'visible' : 'hidden');
      alert(ok ? 'Edici√≥n habilitada' : 'Contrase√±a incorrecta');
    }

    // Guardar en localStorage
    function saveProductos() { localStorage.setItem('productos', JSON.stringify(productos)); }
    function saveVentas()     { localStorage.setItem('ventas',    JSON.stringify(ventas)); }

    // Rellenar Ingreso al elegir o editar producto en Gesti√≥n
    function rellenarIngreso(nombre) {
      document.getElementById('ingreso').value =
        ingresosBalance[nombre.trim().toUpperCase()] || 0;
    }
    document.getElementById('producto')
            .addEventListener('blur', e => rellenarIngreso(e.target.value));

    // Render Tabla Gesti√≥n
    function renderGestion() {
      const tbody = document.getElementById('gestionBody'); tbody.innerHTML = '';
      productos.forEach((p,i) => {
        const v1 = p.ingreso * p.venta;
        const v2 = p.precioVenta * p.saldo;
        tbody.insertAdjacentHTML('beforeend', `
          <tr>
            <td>${i+1}</td>
            <td>${p.producto}</td>
            <td>${p.ingreso}</td>
            <td>S/ ${p.precioCompra.toFixed(2)}</td>
            <td>${p.venta}</td>
            <td>S/ ${p.precioVenta.toFixed(2)}</td>
            <td>${p.saldo}</td>
            <td>${v1}</td>
            <td>S/ ${v2.toFixed(2)}</td>
            <td>
              <button class="btn btn-sm btn-warning edit-btn" onclick="editGestion(${i})">‚úé</button>
              <button class="btn btn-sm btn-danger  delete-btn" onclick="deleteGestion(${i})">üóë</button>
            </td>
          </tr>`);
      });
    }

    // Render Tabla Registro de Ventas
    function renderRegistro() {
      const tbody = document.getElementById('registroBody'); tbody.innerHTML = '';
      ventas.forEach((v,i) => {
        const ingreso = ingresosBalance[v.nombre.trim().toUpperCase()] || 0;
        const egreso  = egresosBalance[v.nombre.trim().toUpperCase()]  || 0;
        tbody.insertAdjacentHTML('beforeend', `
          <tr>
            <td>${v.item}</td>
            <td>${v.codigo}</td>
            <td>${v.nombre}</td>
            <td>${ingreso}</td>
            <td>${egreso}</td>
            <td>${v.unidad}</td>
            <td>
              <button class="btn btn-sm btn-warning edit-btn" onclick="editVenta(${i})">‚úé</button>
              <button class="btn btn-sm btn-danger  delete-btn" onclick="deleteVenta(${i})">üóë</button>
            </td>
          </tr>`);
      });
    }

    // A√±adir producto en Gesti√≥n
    document.getElementById('formGestion').addEventListener('submit', e => {
      e.preventDefault();
      const p = {
        producto:      document.getElementById('producto').value.trim(),
        ingreso:       parseInt(document.getElementById('ingreso').value) || 0,
        precioCompra:  parseFloat(document.getElementById('precioCompra').value),
        venta:         parseInt(document.getElementById('venta').value),
        precioVenta:   parseFloat(document.getElementById('precioVenta').value),
        saldo:         parseInt(document.getElementById('saldo').value)
      };
      if (p.saldo <= 5) {
        const modal = new bootstrap.Modal(document.getElementById('alertaModal'));
        document.getElementById('nombreProductoAlerta').textContent = p.producto;
        modal.show();
        if (p.precioVenta === p.precioCompra) p.precioVenta += 5;
      }
      productos.push(p);
      saveProductos(); renderGestion();
      e.target.reset();
    });

    // Registrar Venta
    document.getElementById('formRegistro').addEventListener('submit', e => {
      e.preventDefault();
      const item   = document.getElementById('itemVenta').value.trim();
      const codigo = document.getElementById('codigoVenta').value.trim();
      const nombre = document.getElementById('nombreVenta').value.trim();
      const uni    = parseInt(document.getElementById('unidadesVendidas').value, 10);

      // Buscar y descontar stock
      const idx = productos.findIndex(p => p.producto === nombre || String(idx+1) === codigo);
      if (idx < 0) return alert('Producto no encontrado en Gesti√≥n.');
      if (uni > productos[idx].saldo) return alert('No hay suficiente saldo.');

      productos[idx].saldo -= uni;
      saveProductos(); renderGestion();

      ventas.push({ item, codigo, nombre, unidad: uni });
      saveVentas(); renderRegistro();

      e.target.reset();
    });

    // Edit/Delete Gesti√≥n
    function deleteGestion(i) {
      productos.splice(i,1); saveProductos(); renderGestion();
    }
    function editGestion(i) {
      const p = productos.splice(i,1)[0];
      document.getElementById('producto').value     = p.producto;
      rellenarIngreso(p.producto);
      document.getElementById('precioCompra').value = p.precioCompra;
      document.getElementById('venta').value        = p.venta;
      document.getElementById('precioVenta').value  = p.precioVenta;
      document.getElementById('saldo').value        = p.saldo;
      saveProductos(); renderGestion();
    }

    // Edit/Delete Ventas
    function deleteVenta(i) {
      ventas.splice(i,1); saveVentas(); renderRegistro();
    }
    function editVenta(i) {
      const v = ventas.splice(i,1)[0];
      // devolver stock
      const prodIdx = productos.findIndex(p => p.producto === v.nombre);
      if (prodIdx >= 0) productos[prodIdx].saldo += v.unidad;
      document.getElementById('itemVenta').value        = v.item;
      document.getElementById('codigoVenta').value      = v.codigo;
      document.getElementById('nombreVenta').value      = v.nombre;
      document.getElementById('unidadesVendidas').value = v.unidad;
      saveVentas(); saveProductos();
      renderGestion(); renderRegistro();
    }

    // Inicializaci√≥n
    renderGestion(); renderRegistro();
  </script>
</body>
</html>

