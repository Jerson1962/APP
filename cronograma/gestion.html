 <!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sistema de Inventario</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <style>
    .btn-flotante { position: fixed; right: 20px; border-radius: 50px; padding:12px 20px; font-size:16px; z-index:1050; box-shadow:0 4px 8px rgba(0,0,0,0.2); }
    .btn-resumen { bottom: 20px; background: #007bff; color:#fff; }
    .btn-historial { bottom: 80px; background: #6c757d; color:#fff; }
    .btn-venta-capital { bottom: 140px; background: #28a745; color:#fff; }
  </style>
</head>
<body class="bg-light">
  <nav class="navbar navbar-dark bg-primary">
    <div class="container-fluid"><a class="navbar-brand" href="cronograma.html">Inventario</a></div>
  </nav>
  <div class="container py-4">
    <div class="card mb-4">
      <div class="card-header bg-secondary text-white">Registrar Movimiento</div>
      <div class="card-body">
        <form id="formMovimiento" class="row g-3">
          <div class="col-md-3">
            <label class="form-label">Fecha</label>
            <input type="date" id="fecha" class="form-control" required>
          </div>
          <div class="col-md-3">
            <label class="form-label">Producto</label>
            <input type="text" id="producto" class="form-control" required>
          </div>
          <div class="col-md-2">
            <label class="form-label">Entrada</label>
            <input type="number" id="entrada" class="form-control" min="0" value="0">
          </div>
          <div class="col-md-2">
            <label class="form-label">Salida</label>
            <input type="number" id="salida" class="form-control" min="0" value="0">
          </div>
          <div class="col-md-2">
            <label class="form-label">Costo Unit.</label>
            <input type="number" id="costoMov" class="form-control" min="0" step="0.01" value="0">
          </div>
          <div class="col-12 text-end">
            <button class="btn btn-primary" type="submit">Agregar</button>
            <button class="btn btn-outline-secondary" type="reset">Limpiar</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Botones flotantes -->
  <button class="btn btn-flotante btn-resumen" data-bs-toggle="modal" data-bs-target="#modalResumen">📊 Inventario</button>
  <button class="btn btn-flotante btn-historial" data-bs-toggle="modal" data-bs-target="#modalHistorial">📄 Historial</button>
  <button class="btn btn-flotante btn-venta-capital" data-bs-toggle="modal" data-bs-target="#modalVentaCapital">💰🛒 Venta & Capital</button>
  
  <!-- Modal Resumen (Inventario) -->
  <div class="modal fade" id="modalResumen" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header bg-secondary text-white">
          <h5 class="modal-title">Stock y Costos</h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body p-0">
          <div class="table-responsive">
            <table class="table mb-0" id="tablaResumen">
              <thead class="table-dark">
                <tr>
                  <th>Producto</th>
                  <th>Stock</th>
                  <th>Costo Unit.</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-danger me-auto" onclick="reiniciarTodo()">🗑 Reiniciar Todo</button>
          <button class="btn btn-outline-secondary" data-bs-dismiss="modal">Cerrar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Historial Movimientos -->
  <div class="modal fade" id="modalHistorial" tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header bg-dark text-white">
          <h5 class="modal-title">Historial de Movimientos</h5>
          <button class="btn btn-secondary me-2" onclick="exportMovimientosPDF()">📥 PDF</button>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body p-0">
          <div class="table-responsive">
            <table class="table table-striped mb-0" id="tablaMovimientos">
              <thead class="table-dark">
                <tr>
                  <th>#</th>
                  <th>Fecha</th>
                  <th>Producto</th>
                  <th>Entrada</th>
                  <th>Salida</th>
                  <th>Saldo</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-outline-secondary" data-bs-dismiss="modal">Cerrar</button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Modal Venta & Capital -->
  <div class="modal fade" id="modalVentaCapital" tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header bg-success text-white">
          <h5 class="modal-title">Venta & Capital</h5>
          <div class="ms-auto">
            <div>Capital: S/ <span id="capitalVC">0.00</span></div>
            <div>Valor de Stock: S/ <span id="valorStock">0.00</span></div>
            <div>Total General: S/ <span id="totalGeneral">0.00</span></div>
          </div>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="row">
            <!-- Formulario de Venta -->
            <div class="col-md-6">
              <form id="formVenta" class="row g-3">
                <div class="col-6">
                  <label class="form-label">Producto</label>
                  <select id="selectVenta" class="form-select" required></select>
                </div>
                <div class="col-3">
                  <label class="form-label">Cantidad</label>
                  <input type="number" id="cantVenta" class="form-control" min="1" required>
                </div>
                <div class="col-3">
                  <label class="form-label">Costo Unit.</label>
                  <input type="number" id="precioCosto" class="form-control" step="0.01" readonly>
                </div>
                <div class="col-3">
                  <label class="form-label">Precio Venta</label>
                  <input type="number" id="precioVenta" class="form-control" min="0" step="0.01" required>
                </div>
                <div class="col-12 text-end">
                  <button type="button" id="calcGain" class="btn btn-info">Calcular Ganancia</button>
                </div>
              </form>
              <div class="mt-2">Ganancia: S/ <span id="gananciaCalc">0.00</span></div>
              <div class="text-end mt-2">
                <button id="regVenta" class="btn btn-success">Registrar Venta</button>
              </div>
            </div>
            <!-- Historial Ventas -->
            <div class="col-md-6">
              <h6>Historial de Ventas <button class="btn btn-sm btn-secondary ms-2" onclick="exportVentasPDF()">📥 PDF</button></h6>
              <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                <table class="table table-bordered">
                  <thead class="table-dark">
                    <tr>
                      <th>Fecha</th>
                      <th>Producto</th>
                      <th>Cant.</th>
                      <th>Costo</th>
                      <th>Precio Venta</th>
                      <th>Total Costo</th>
                      <th>Ganancia</th>
                    </tr>
                  </thead>
                  <tbody id="bodyVentas"></tbody>
                </table>
              </div>
            </div>
          </div>

          <!-- Sección de ingreso de nueva mercadería -->
          <hr>
          <h6 class="mt-3">Ingresar Nueva Mercadería al Inventario</h6>
          <form id="formIngresoProducto" class="row g-3 mt-1">
            <div class="col-md-4">
              <label class="form-label">Nombre del Producto</label>
              <input type="text" id="nuevoProducto" class="form-control" required>
            </div>
            <div class="col-md-2">
              <label class="form-label">Cantidad</label>
              <input type="number" id="nuevaCantidad" class="form-control" min="1" required>
            </div>
            <div class="col-md-2">
              <label class="form-label">Costo Unitario</label>
              <input type="number" id="nuevoCosto" class="form-control" min="0" step="0.01" required>
            </div>
            <div class="col-md-4 d-flex align-items-end justify-content-end">
              <button type="submit" class="btn btn-primary">Agregar al Inventario</button>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button class="btn btn-outline-secondary" data-bs-dismiss="modal">Cerrar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Botón Proyección -->
  <button
    id="btnProyeccion"
    class="btn btn-warning rounded-circle"
    style="position: fixed; left: 20px; bottom: 200px; padding:12px 20px; font-size:16px; z-index:1050;"
    data-bs-toggle="modal"
    data-bs-target="#modalProyeccion"
    title="Proyección de Ganancias"
  >
    📈
  </button>

  <!-- Modal Proyección -->
  <div class="modal fade" id="modalProyeccion" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content border-warning">
        <div class="modal-header bg-warning text-dark">
          <h5 class="modal-title">Proyección de Ganancia</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="selectProyInv" class="form-label">Seleccionar Producto</label>
            <select id="selectProyInv" class="form-select"></select>
          </div>
          <div class="mb-3">
            <label for="precioVentaProy" class="form-label">Precio de Venta (unidad)</label>
            <input type="number" id="precioVentaProy" class="form-control" step="0.01" placeholder="S/">
          </div>
          <div class="mb-3">
            <p id="resultadoProyeccion" class="fw-bold"></p>
          </div>
        </div>
        <div class="modal-footer">
          <button id="btnCalcularProyeccion" class="btn btn-success">Calcular</button>
          <button class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Variables globales
    let stock = {}, costos = {}, movs = [], ventas = [], capital = 0;
    const tbRes = document.querySelector('#tablaResumen tbody'),
          tbMov = document.querySelector('#tablaMovimientos tbody'),
          selV = document.getElementById('selectVenta'),
          tbVen = document.getElementById('bodyVentas'),
          spanCapital = document.getElementById('capitalVC'),
          spanStock = document.getElementById('valorStock'),
          spanTotal = document.getElementById('totalGeneral');

    // Guardar en localStorage
    function save() {
      localStorage.setItem('stk', JSON.stringify(stock));
      localStorage.setItem('cost', JSON.stringify(costos));
      localStorage.setItem('mov', JSON.stringify(movs));
      localStorage.setItem('ven', JSON.stringify(ventas));
      localStorage.setItem('cap', capital.toString());
      console.log('Datos guardados:', { stock, costos, movs, ventas, capital });
    }

    // Cargar desde localStorage
    function load() {
      stock = JSON.parse(localStorage.getItem('stk') || '{}');
      costos = JSON.parse(localStorage.getItem('cost') || '{}');
      movs = JSON.parse(localStorage.getItem('mov') || '[]');
      ventas = JSON.parse(localStorage.getItem('ven') || '[]');
      capital = parseFloat(localStorage.getItem('cap') || '0');
      console.log('Datos cargados:', { stock, costos, movs, ventas, capital });
      renderAll();
    }

    // Establecer fecha actual
    function setFechaActual() {
      const today = new Date();
      const year = today.getFullYear();
      const month = String(today.getMonth() + 1).padStart(2, '0');
      const day = String(today.getDate()).padStart(2, '0');
      document.getElementById('fecha').value = `${year}-${month}-${day}`;
    }

    // Evento para movimientos de stock
    document.getElementById('formMovimiento').addEventListener('submit', function(e) {
      e.preventDefault();
      
      const f = document.getElementById('fecha').value;
      const p = document.getElementById('producto').value.trim();
      const ent = parseFloat(document.getElementById('entrada').value) || 0;
      const sal = parseFloat(document.getElementById('salida').value) || 0;
      const cMov = parseFloat(document.getElementById('costoMov').value) || 0;
      
      // Validaciones
      if (!f || !p) {
        alert('Fecha y producto son obligatorios');
        return;
      }
      
      if (ent > 0 && sal > 0) {
        alert('Solo puedes registrar entrada O salida, no ambas');
        return;
      }
      
      if (ent === 0 && sal === 0) {
        alert('Debes registrar al menos una entrada o salida');
        return;
      }
      
      // Inicializar producto si no existe
      if (!(p in stock)) {
        stock[p] = 0;
      }
      if (!(p in costos)) {
        costos[p] = cMov;
      }
      
      // Verificar stock suficiente para salidas
      if (sal > 0 && sal > stock[p]) {
        alert('Stock insuficiente. Stock actual: ' + stock[p]);
        return;
      }
      
      // Actualizar stock
      stock[p] += ent - sal;
      
      // Si es entrada y hay costo, actualizar costo
      if (ent > 0 && cMov > 0) {
        costos[p] = cMov;
      }
      
      // Agregar movimiento al historial
      const movimiento = {
        id: movs.length + 1,
        fecha: f,
        producto: p,
        entrada: ent,
        salida: sal,
        saldo: stock[p]
      };
      
      movs.push(movimiento);
      
      save();
      renderAll();
      e.target.reset();
      setFechaActual();
      
      alert('Movimiento registrado correctamente');
    });

    // Render tabla resumen
    function renderRes() {
      if (!tbRes) return;
      tbRes.innerHTML = '';
      
      for (const p in stock) {
        const fila = document.createElement('tr');
        fila.innerHTML = `
          <td>${p}</td>
          <td>${stock[p]}</td>
          <td>S/ ${(costos[p] || 0).toFixed(2)}</td>
          <td>
            <button class='btn btn-sm btn-outline-primary me-1' onclick="editNombre('${p.replace(/'/g, "\\\'")}')" title="Editar Nombre">✏️</button>
            <button class='btn btn-sm btn-outline-warning' onclick="editCosto('${p.replace(/'/g, "\\\'")}')" title="Editar Costo">💰</button>
          </td>
        `;
        tbRes.appendChild(fila);
      }
    }

    // Render historial movimientos
    function renderMov() {
      if (!tbMov) return;
      tbMov.innerHTML = '';
      
      movs.forEach(m => {
        const fila = document.createElement('tr');
        fila.innerHTML = `
          <th>${m.id}</th>
          <td>${m.fecha}</td>
          <td>${m.producto}</td>
          <td class="text-success">${m.entrada}</td>
          <td class="text-danger">${m.salida}</td>
          <td>${m.saldo}</td>
        `;
        tbMov.appendChild(fila);
      });
    }

    // Render historial ventas
    function renderVen() {
      if (!tbVen) return;
      tbVen.innerHTML = '';
      
      ventas.forEach(v => {
        const fila = document.createElement('tr');
        fila.innerHTML = `
          <td>${v.fecha}</td>
          <td>${v.producto}</td>
          <td>${v.cantidad}</td>
          <td>S/ ${v.costo}</td>
          <td>S/ ${v.precioVenta}</td>
          <td>S/ ${v.totalCosto}</td>
          <td>S/ ${v.ganancia}</td>
        `;
        tbVen.appendChild(fila);
      });
    }

    // Llenar selector de venta
    function fillSel() {
      if (!selV) return;
      selV.innerHTML = '<option value="">Seleccionar producto...</option>';
      
      for (const p in stock) {
        if (stock[p] > 0) {
          const option = document.createElement('option');
          option.value = p;
          option.textContent = `${p} (Stock: ${stock[p]})`;
          selV.appendChild(option);
        }
      }
    }

    // Al cambiar producto en venta
    if (selV) {
      selV.addEventListener('change', function() {
        const p = selV.value;
        const precioCostoInput = document.getElementById('precioCosto');
        if (precioCostoInput && p) {
          precioCostoInput.value = (costos[p] || 0).toFixed(2);
        }
      });
    }

    // Calcular ganancia
    const calcGainBtn = document.getElementById('calcGain');
    if (calcGainBtn) {
      calcGainBtn.addEventListener('click', function() {
        const q = parseFloat(document.getElementById('cantVenta').value) || 0;
        const c = parseFloat(document.getElementById('precioCosto').value) || 0;
        const pv = parseFloat(document.getElementById('precioVenta').value) || 0;
        
        if (q <= 0) {
          alert('Cantidad debe ser mayor a 0');
          return;
        }
        
        if (pv < c) {
          alert('Precio de venta no puede ser menor al costo');
          return;
        }
        
        const ganancia = (pv - c) * q;
        document.getElementById('gananciaCalc').textContent = ganancia.toFixed(2);
      });
    }

    // Registrar venta
    const regVentaBtn = document.getElementById('regVenta');
    if (regVentaBtn) {
      regVentaBtn.addEventListener('click', function() {
        const p = selV.value;
        const q = parseFloat(document.getElementById('cantVenta').value) || 0;
        const c = parseFloat(document.getElementById('precioCosto').value) || 0;
        const pv = parseFloat(document.getElementById('precioVenta').value) || 0;
        const gan = parseFloat(document.getElementById('gananciaCalc').textContent) || 0;
        
        if (!p) {
          alert('Selecciona un producto');
          return;
        }
        
        if (q <= 0) {
          alert('La cantidad debe ser mayor a 0');
          return;
        }
        
        if (q > stock[p]) {
          alert('Stock insuficiente. Stock disponible: ' + stock[p]);
          return;
        }
        
        if (pv <= 0) {
          alert('El precio de venta debe ser mayor a 0');
          return;
        }
        
        // Registrar venta
        const now = new Date();
        const fh = now.toLocaleDateString() + ' ' + now.toLocaleTimeString();
        const totalCosto = (c * q).toFixed(2);
        
        stock[p] -= q;
        capital += pv * q;
        
        const venta = {
          fecha: fh,
          producto: p,
          cantidad: q,
          costo: c.toFixed(2),
          precioVenta: pv.toFixed(2),
          totalCosto: totalCosto,
          ganancia: gan.toFixed(2)
        };
        
        ventas.push(venta);
        
        // Agregar movimiento de venta
        const movimiento = {
          id: movs.length + 1,
          fecha: now.toLocaleDateString(),
          producto: `${p} (Venta)`,
          entrada: 0,
          salida: q,
          saldo: stock[p]
        };
        
        movs.push(movimiento);
        
        save();
        renderAll();
        
        // Limpiar formulario
        document.getElementById('cantVenta').value = '';
        document.getElementById('precioVenta').value = '';
        document.getElementById('gananciaCalc').textContent = '0.00';
        selV.value = '';
        document.getElementById('precioCosto').value = '';
        
        alert('Venta registrada correctamente');
      });
    }

    // Ingresar nueva mercadería
    const formIngresoProducto = document.getElementById('formIngresoProducto');
    if (formIngresoProducto) {
      formIngresoProducto.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const nombre = document.getElementById('nuevoProducto').value.trim();
        const cantidad = parseFloat(document.getElementById('nuevaCantidad').value) || 0;
        const costoUnitario = parseFloat(document.getElementById('nuevoCosto').value) || 0;
        
        if (!nombre) {
          alert('El nombre del producto es obligatorio');
          return;
        }
        
        if (cantidad <= 0) {
          alert('La cantidad debe ser mayor a 0');
          return;
        }
        
        if (costoUnitario < 0) {
          alert('El costo unitario no puede ser negativo');
          return;
        }
        
        // Inicializar o actualizar stock
        if (!(nombre in stock)) {
          stock[nombre] = 0;
        }
        
        stock[nombre] += cantidad;
        costos[nombre] = costoUnitario;
        
        // Agregar movimiento
        const now = new Date();
        const fh = now.toLocaleDateString() + ' ' + now.toLocaleTimeString();
        
        const movimiento = {
          id: movs.length + 1,
          fecha: now.toLocaleDateString(),
          producto: `${nombre} (Ingreso)`,
          entrada: cantidad,
          salida: 0,
          saldo: stock[nombre]
        };
        
        movs.push(movimiento);
        
        save();
        renderAll();
        e.target.reset();
        
        alert('Mercadería agregada al inventario correctamente');
      });
    }

    // NUEVA FUNCIÓN: Editar nombre del producto
    function editNombre(nombreAntiguo) {
      if (prompt('Contraseña:') !== 'fernandez') {
        alert('Contraseña incorrecta');
        return;
      }
      
      const nuevoNombre = prompt(`Nuevo nombre para "${nombreAntiguo}":`, nombreAntiguo);
      
      if (!nuevoNombre || nuevoNombre.trim() === '') {
        alert('El nombre no puede estar vacío');
        return;
      }
      
      const nombreTrim = nuevoNombre.trim();
      
      // Verificar que el nuevo nombre no exista ya (excepto si es el mismo)
      if (nombreTrim !== nombreAntiguo && stock[nombreTrim] !== undefined) {
        alert('Ya existe un producto con ese nombre');
        return;
      }
      
      // Si el nombre no cambió, no hacer nada
      if (nombreTrim === nombreAntiguo) {
        alert('El nombre no ha cambiado');
        return;
      }
      
      // Actualizar el stock y costos con el nuevo nombre
      stock[nombreTrim] = stock[nombreAntiguo];
      costos[nombreTrim] = costos[nombreAntiguo];
      
      // Eliminar las entradas antiguas
      delete stock[nombreAntiguo];
      delete costos[nombreAntiguo];
      
      // Actualizar movimientos históricos
      movs.forEach(mov => {
        if (mov.producto === nombreAntiguo) {
          mov.producto = nombreTrim;
        } else if (mov.producto === `${nombreAntiguo} (Venta)`) {
          mov.producto = `${nombreTrim} (Venta)`;
        } else if (mov.producto === `${nombreAntiguo} (Ingreso)`) {
          mov.producto = `${nombreTrim} (Ingreso)`;
        }
      });
      
      // Actualizar ventas históricas
      ventas.forEach(venta => {
        if (venta.producto === nombreAntiguo) {
          venta.producto = nombreTrim;
        }
      });
      
      save(); 
      renderAll(); 
      alert(`Producto renombrado de "${nombreAntiguo}" a "${nombreTrim}"`);
    }

    // Editar costo con contraseña
    function editCosto(p) {
      if (prompt('Contraseña:') !== 'fernandez') {
        alert('Contraseña incorrecta');
        return;
      }
      
      const nuevoCosto = prompt(`Nuevo costo para ${p}:`, costos[p] || 0);
      const valor = parseFloat(nuevoCosto);
      
      if (!isNaN(valor) && valor >= 0) {
        costos[p] = valor;
        save();
        renderRes();
        alert('Costo actualizado correctamente');
      } else {
        alert('Valor inválido');
      }
    }

    // Reiniciar todo
    function reiniciarTodo() {
      if (prompt('Contraseña:') !== 'fernandez') {
        alert('Contraseña incorrecta');
        return;
      }
      
      if (confirm('¿Estás seguro de que quieres borrar todos los datos? Esta acción no se puede deshacer.')) {
        localStorage.clear();
        stock = {};
        costos = {};
        movs = [];
        ventas = [];
        capital = 0;
        renderAll();
        alert('Sistema reiniciado correctamente');
      }
    }

    // Exportar PDF movimientos
    function exportMovimientosPDF() {
      const tabla = document.getElementById('tablaMovimientos').parentElement;
      html2pdf()
        .set({
          margin: 0.4,
          filename: 'Movimientos_' + new Date().toLocaleDateString().replace(/\//g, '-') + '.pdf',
          html2canvas: { scale: 2 },
          jsPDF: { unit: 'in', format: 'letter', orientation: 'landscape' }
        })
        .from(tabla)
        .save();
    }
    
    // Exportar PDF ventas
    function exportVentasPDF() {
      const tabla = tbVen.parentElement;
      html2pdf()
        .set({
          margin: 0.4,
          filename: 'Ventas_' + new Date().toLocaleDateString().replace(/\//g, '-') + '.pdf',
          html2canvas: { scale: 2 },
          jsPDF: { unit: 'in', format: 'letter', orientation: 'landscape' }
        })
        .from(tabla)
        .save();
    }

    // Calcular y mostrar indicadores
    function actualizarIndicadores() {
      // Valor stock = sum(stock[p] * costos[p])
      let valorStock = 0;
      for (const p in stock) {
        valorStock += stock[p] * (costos[p] || 0);
      }
      
      if (spanStock) spanStock.textContent = valorStock.toFixed(2);
      if (spanCapital) spanCapital.textContent = capital.toFixed(2);
      if (spanTotal) spanTotal.textContent = (capital + valorStock).toFixed(2);
    }

    // Renderizar todo
    function renderAll() {
      renderRes();
      renderMov();
      renderVen();
      fillSel();
      actualizarIndicadores();
      llenarSelectProyeccion();
    }

    // Llenar selector de proyección
    function llenarSelectProyeccion() {
      const selectProy = document.getElementById("selectProyInv");
      if (!selectProy) return;
      
      selectProy.innerHTML = '<option value="">Seleccionar producto...</option>';
      
      for (const nombre in stock) {
        if (stock[nombre] > 0) {
          const option = document.createElement("option");
          option.value = nombre;
          option.textContent = `${nombre} (Stock: ${stock[nombre]})`;
          selectProy.appendChild(option);
        }
      }
    }

    // Proyección de ganancias - Calcular
    const btnCalcularProyeccion = document.getElementById("btnCalcularProyeccion");
    if (btnCalcularProyeccion) {
      btnCalcularProyeccion.addEventListener("click", function() {
        const producto = document.getElementById("selectProyInv").value;
        const precioVenta = parseFloat(document.getElementById("precioVentaProy").value);
        const resultado = document.getElementById("resultadoProyeccion");

        if (!producto) {
          resultado.textContent = "Selecciona un producto primero.";
          resultado.className = "text-danger fw-bold";
          return;
        }
        
        if (isNaN(precioVenta) || precioVenta <= 0) {
          resultado.textContent = "Ingresa un precio de venta válido.";
          resultado.className = "text-danger fw-bold";
          return;
        }

        const cantidad = stock[producto] || 0;
        const costo = costos[producto] || 0;
        const ganancia = (precioVenta - costo) * cantidad;
        const totalVenta = precioVenta * cantidad;
        const totalCosto = costo * cantidad;

        resultado.innerHTML = `
          <div class="border rounded p-3 bg-light">
            <strong>Proyección para: ${producto}</strong><br>
            <div class="row mt-2">
              <div class="col-6">Stock disponible: <strong>${cantidad}</strong></div>
              <div class="col-6">Costo unitario: <strong>S/ ${costo.toFixed(2)}</strong></div>
            </div>
            <hr class="my-2">
            <div class="row">
              <div class="col-6">Total ventas: <span class="text-info">S/ ${totalVenta.toFixed(2)}</span></div>
              <div class="col-6">Total costos: <span class="text-secondary">S/ ${totalCosto.toFixed(2)}</span></div>
            </div>
            <div class="mt-2">
              <strong>Ganancia proyectada: 
                <span class="${ganancia >= 0 ? 'text-success' : 'text-danger'}">
                  S/ ${ganancia.toFixed(2)}
                </span>
              </strong>
            </div>
          </div>
        `;
        resultado.className = "";
      });
    }

    // Inicialización cuando se carga el documento
    document.addEventListener('DOMContentLoaded', function() {
      console.log('Inicializando aplicación...');
      setFechaActual();
      load();
      
      // Event listener para limpiar proyección al cerrar modal
      const modalProyeccion = document.getElementById('modalProyeccion');
      if (modalProyeccion) {
        modalProyeccion.addEventListener('hidden.bs.modal', function() {
          document.getElementById('precioVentaProy').value = '';
          document.getElementById('resultadoProyeccion').textContent = '';
          document.getElementById('selectProyInv').value = '';
        });
      }

      // Event listener para actualizar selector al abrir modal de proyección
      const btnProyeccion = document.getElementById('btnProyeccion');
      if (btnProyeccion) {
        btnProyeccion.addEventListener('click', function() {
          llenarSelectProyeccion();
        });
      }

      // Event listener para actualizar selectores al abrir modal de ventas
      const modalVentaCapital = document.getElementById('modalVentaCapital');
      if (modalVentaCapital) {
        modalVentaCapital.addEventListener('show.bs.modal', function() {
          fillSel();
          actualizarIndicadores();
        });
      }
    });

    // Hacer funciones globales para que funcionen los onclick
    window.editNombre = editNombre;
    window.editCosto = editCosto;
    window.reiniciarTodo = reiniciarTodo;
    window.exportMovimientosPDF = exportMovimientosPDF;
    window.exportVentasPDF = exportVentasPDF;
  </script>
</body>
</html>   
        
   
