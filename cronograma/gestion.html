  <!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Gesti√≥n y Registro de Mercader√≠a</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background-color: #728abb; padding: 2rem; }
    .card { margin-bottom: 2rem; border-radius: 15px; box-shadow: 0 0 10px rgba(0,0,0,0.3); }
    .edit-btn, .delete-btn { visibility: hidden; }
  </style>
</head>
<body>

  <!-- Contrase√±a Maestra -->
  <div class="container">
    <h2 class="text-white">üîê Desbloquear Edici√≥n</h2>
    <div class="input-group mb-4">
      <input type="password" id="masterPassword" class="form-control" placeholder="Contrase√±a maestra">
      <button class="btn btn-outline-light" onclick="unlockEditing()">Validar</button>
    </div>
  </div>

  <!-- 1) GESTI√ìN DE MERCADER√çA -->
  <div class="container card bg-white p-4">
    <h3>üì¶ Gesti√≥n de Mercader√≠a</h3>
    <form id="formGestion" class="row g-3 mb-4">
      <div class="col-md-3">
        <input type="text" class="form-control" id="producto" placeholder="Producto" required>
      </div>
      <div class="col-md-2">
        <input type="number" class="form-control" id="ingreso" placeholder="Ingreso" required>
      </div>
      <div class="col-md-2">
        <input type="number" step="0.01" class="form-control" id="precioCompra" placeholder="Costo" required>
      </div>
      <div class="col-md-1">
        <input type="number" class="form-control" id="venta" placeholder="Venta" required>
      </div>
      <div class="col-md-2">
        <input type="number" step="0.01" class="form-control" id="precioVenta" placeholder="Precio Venta" required>
      </div>
      <div class="col-md-1">
        <input type="number" class="form-control" id="saldo" placeholder="Saldo" required>
      </div>
      <div class="col-md-1">
        <button type="submit" class="btn btn-success w-100">+ Agregar</button>
      </div>
    </form>

    <div class="table-responsive">
      <table class="table table-striped table-bordered text-center">
        <thead class="table-dark">
          <tr>
            <th>#</th><th>Producto</th><th>Ingreso</th><th>Costo</th>
            <th>Venta</th><th>Precio Venta</th><th>Saldo</th>
            <th>Val.1<br><small>Ingreso√óVenta</small></th>
            <th>Val.2<br><small>PrecioVenta√óSaldo</small></th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody id="gestionBody"></tbody>
      </table>
    </div>
  </div>

  <!-- 2) REGISTRO DE VENTAS -->
  <div class="container card bg-white p-4">
    <h3>üìù Registro de Ventas</h3>
    <form id="formRegistro" class="row g-3 mb-4">
      <div class="col-md-2">
        <select id="selProducto" class="form-select" required>
          <option value="" disabled selected>Seleccione producto</option>
        </select>
      </div>
      <div class="col-md-2">
        <input type="number" step="0.01" id="costoVenta" class="form-control" placeholder="Costo" readonly>
      </div>
      <div class="col-md-2">
        <input type="number" step="0.01" id="precioVentaReg" class="form-control" placeholder="Precio Venta" readonly>
      </div>
      <div class="col-md-2">
        <input type="number" id="unidadesVendidas" class="form-control" placeholder="Unidades" required>
      </div>
      <div class="col-md-2">
        <button type="submit" class="btn btn-primary w-100">Registrar Venta</button>
      </div>
    </form>

    <div class="table-responsive">
      <table class="table table-striped table-bordered text-center">
        <thead class="table-dark">
          <tr>
            <th>Item</th><th>C√≥digo</th><th>Nombre</th>
            <th>Costo</th><th>Venta</th><th>Unidad</th><th>Acciones</th>
          </tr>
        </thead>
        <tbody id="registroBody"></tbody>
      </table>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    const MASTER_PWD = 'fernandez';
    let productos = JSON.parse(localStorage.getItem('productos')) || [];
    let ventas    = JSON.parse(localStorage.getItem('ventas'))    || [];

    // Desbloquear edici√≥n
    function unlockEditing() {
      const ok = document.getElementById('masterPassword').value === MASTER_PWD;
      document.querySelectorAll('.edit-btn, .delete-btn').forEach(b => b.style.visibility = ok ? 'visible' : 'hidden');
      alert(ok ? 'Edici√≥n habilitada' : 'Contrase√±a incorrecta');
    }

    // Guardar LS
    function saveProductos() {
      localStorage.setItem('productos', JSON.stringify(productos));
    }
    function saveVentas() {
      localStorage.setItem('ventas', JSON.stringify(ventas));
    }

    // Render Gesti√≥n
    function renderGestion() {
      const tbody = document.getElementById('gestionBody');
      tbody.innerHTML = '';
      productos.forEach((p,i) => {
        const v1 = p.ingreso * p.venta;
        const v2 = p.precioVenta * p.saldo;
        tbody.insertAdjacentHTML('beforeend', `
          <tr>
            <td>${i+1}</td>
            <td>${p.producto}</td>
            <td>${p.ingreso}</td>
            <td>S/ ${p.precioCompra.toFixed(2)}</td>
            <td>${p.venta}</td>
            <td>S/ ${p.precioVenta.toFixed(2)}</td>
            <td>${p.saldo}</td>
            <td>${v1}</td>
            <td>S/ ${v2.toFixed(2)}</td>
            <td>
              <button class="btn btn-sm btn-warning edit-btn" onclick="editGestion(${i})">‚úé</button>
              <button class="btn btn-sm btn-danger delete-btn" onclick="deleteGestion(${i})">üóë</button>
            </td>
          </tr>
        `);
      });
      refreshSelect();
    }

    // Render Registro
    function renderRegistro() {
      const tbody = document.getElementById('registroBody');
      tbody.innerHTML = '';
      ventas.forEach((v,i) => {
        tbody.insertAdjacentHTML('beforeend', `
          <tr>
            <td>${i+1}</td>
            <td>${v.codigo}</td>
            <td>${v.nombre}</td>
            <td>S/ ${v.costo.toFixed(2)}</td>
            <td>S/ ${v.venta.toFixed(2)}</td>
            <td>${v.unidad}</td>
            <td>
              <button class="btn btn-sm btn-warning edit-btn" onclick="editVenta(${i})">‚úé</button>
              <button class="btn btn-sm btn-danger delete-btn" onclick="deleteVenta(${i})">üóë</button>
            </td>
          </tr>
        `);
      });
    }

    // Refrescar dropdown de productos
    function refreshSelect() {
      const sel = document.getElementById('selProducto');
      sel.innerHTML = '<option value="" disabled selected>Seleccione producto</option>';
      productos.forEach((p,i) => {
        sel.innerHTML += `<option value="${i}">${p.producto}</option>`;
      });
    }

    // Al seleccionar producto en registro, cargar costo/venta
    document.getElementById('selProducto').addEventListener('change', e => {
      const p = productos[e.target.value];
      document.getElementById('costoVenta').value   = p.precioCompra.toFixed(2);
      document.getElementById('precioVentaReg').value = p.precioVenta.toFixed(2);
    });

    // A√±adir producto
    document.getElementById('formGestion').addEventListener('submit', e => {
      e.preventDefault();
      const p = {
        producto:      document.getElementById('producto').value.trim(),
        ingreso:       parseInt(document.getElementById('ingreso').value),
        precioCompra:  parseFloat(document.getElementById('precioCompra').value),
        venta:         parseInt(document.getElementById('venta').value),
        precioVenta:   parseFloat(document.getElementById('precioVenta').value),
        saldo:         parseInt(document.getElementById('saldo').value)
      };
      // alerta + aumento S/5
      if (p.saldo <= 5) {
        const modal = new bootstrap.Modal(document.getElementById('alertaModal'), {});
        document.getElementById('nombreProductoAlerta').textContent = p.producto;
        modal.show();
        if (p.precioVenta === p.precioCompra) p.precioVenta += 5;
      }
      productos.push(p);
      saveProductos(); renderGestion();
      e.target.reset();
    });

    // Registrar venta
    document.getElementById('formRegistro').addEventListener('submit', e => {
      e.preventDefault();
      const idx  = parseInt(document.getElementById('selProducto').value);
      const uni  = parseInt(document.getElementById('unidadesVendidas').value);
      if (uni > productos[idx].saldo) {
        return alert('No hay suficiente saldo para esa venta.');
      }
      // descontar saldo
      productos[idx].saldo -= uni;
      // crear venta
      ventas.push({
        codigo:      idx+1,
        nombre:      productos[idx].producto,
        costo:       productos[idx].precioCompra,
        venta:       productos[idx].precioVenta,
        unidad:      uni
      });
      saveProductos(); saveVentas();
      renderGestion(); renderRegistro();
      e.target.reset();
      document.getElementById('costoVenta').value = '';
      document.getElementById('precioVentaReg').value = '';
    });

    // Funciones Edit/Delete Gesti√≥n
    function deleteGestion(i) {
      productos.splice(i,1);
      saveProductos(); renderGestion();
    }
    function editGestion(i) {
      const p = productos.splice(i,1)[0];
      document.getElementById('producto').value     = p.producto;
      document.getElementById('ingreso').value      = p.ingreso;
      document.getElementById('precioCompra').value = p.precioCompra;
      document.getElementById('venta').value        = p.venta;
      document.getElementById('precioVenta').value  = p.precioVenta;
      document.getElementById('saldo').value        = p.saldo;
      saveProductos(); renderGestion();
    }

    // Funciones Edit/Delete Venta
    function deleteVenta(i) {
      ventas.splice(i,1);
      saveVentas(); renderRegistro();
    }
    function editVenta(i) {
      const v = ventas.splice(i,1)[0];
      // al editar venta, devolver unidades al producto
      productos[v.codigo-1].saldo += v.unidad;
      document.getElementById('selProducto').value = v.codigo-1;
      document.getElementById('costoVenta').value   = v.costo.toFixed(2);
      document.getElementById('precioVentaReg').value = v.venta.toFixed(2);
      document.getElementById('unidadesVendidas').value = v.unidad;
      saveVentas(); saveProductos();
      renderGestion(); renderRegistro();
    }

    // Modal de alerta (saldo bajo)
    document.body.insertAdjacentHTML('beforeend', `
      <div class="modal fade" id="alertaModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content border-warning">
            <div class="modal-header bg-warning text-dark">
              <h5 class="modal-title">‚ö†Ô∏è Stock Bajo</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
              El producto <strong id="nombreProductoAlerta"></strong> tiene <strong>saldo bajo</strong> (‚â§ 5 unidades).<br>
              üí° Se recomienda comprar m√°s y subirle S/5 al precio de venta.
            </div>
            <div class="modal-footer">
              <button class="btn btn-outline-warning" data-bs-dismiss="modal">Entendido</button>
            </div>
          </div>
        </div>
      </div>
    `);

    // Iniciar
    renderGestion();
    renderRegistro();
  </script>
</body>
</html>
