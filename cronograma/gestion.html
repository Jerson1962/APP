 <!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Balance + Inventario y Gestión</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .sidebar { position: fixed; top: 0; left: 0; width: 250px; height: 100%; background: #343a40; color: #fff; padding-top: 20px; transition: left .3s ease; z-index:1000; }
    .sidebar.show { left: 0; }
    .sidebar a { color: #fff; padding: 10px 20px; display: block; text-decoration: none; }
    .sidebar a:hover { background: #495057; }
    .hamburger { display: none; position: absolute; top: 20px; left: 20px; font-size: 30px; color: #343a40; background: none; border: none; cursor: pointer; z-index:1100; }
    @media(max-width:767px) { .sidebar { left: -250px; } .hamburger { display: block; } }
    .content { margin-left: 260px; padding: 20px; }
    .panel { background: #f8f9fa; border-radius: 8px; padding: 20px; margin-bottom: 15px; }
    .total { margin-top:10px; font-weight:bold; }
    .action-btn { margin-left:5px; }
    .card { margin-bottom: 2rem; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.2); }
    .edit-btn, .delete-btn { visibility: hidden; }
  </style>
</head>
<body>

  <button class="hamburger" id="hamburgerMenu" aria-label="Mostrar menú">☰</button>
  <nav class="sidebar" id="sidebarNav">
    <h3 class="text-center text-white">𝐌𝐆 𝐀𝐔𝐓𝐎𝐌𝐎𝐓𝐑𝐈𝐙</h3>
    <a href="#incomePanel">Ingresos</a>
    <a href="#expensePanel">Egresos</a>
    <a href="#inventarioSection">Inventario</a>
    <a href="#gestionSection">Gestión</a>
  </nav>

  <main class="content">
    <div class="container">

      <div class="text-right mb-2">
        <button class="btn btn-warning" id="manageBtn">Gestionar (editar/eliminar)</button>
      </div>

      <!-- Ingresos -->
      <section class="panel" id="incomePanel">
        <h3>Registro de Ingresos</h3>
        <form id="incomeForm" class="form-row">
          <input type="date" id="incomeDate" class="form-control col-md-2" required>
          <input type="text" id="incomeConcept" class="form-control col-md-2" placeholder="Concepto" required>
          <input type="text" id="incomeDocType" class="form-control col-md-2" placeholder="Tipo de Doc" required>
          <input type="text" id="incomeMethod" class="form-control col-md-2" placeholder="Método de Pago" required>
          <input type="number" step="0.01" id="incomeAmount" class="form-control col-md-2" placeholder="Monto" required>
          <button type="submit" class="btn btn-success col-md-2">Agregar</button>
        </form>
        <div id="totalIncome" class="total">Total Ingresos: $0</div>
      </section>

      <!-- Egresos -->
      <section class="panel" id="expensePanel">
        <h3>Registro de Egresos</h3>
        <form id="expenseForm" class="form-row">
          <input type="date" id="expenseDate" class="form-control col-md-3" required>
          <input type="text" id="expenseConcept" class="form-control col-md-3" placeholder="Concepto" required>
          <input type="number" step="0.01" id="expenseAmount" class="form-control col-md-3" placeholder="Monto" required>
          <button type="submit" class="btn btn-danger col-md-3">Agregar</button>
        </form>
        <div id="totalExpense" class="total">Total Egresos: $0</div>
      </section>

      <!-- Saldo Total -->
      <section class="panel">
        <h3>Saldo Total</h3>
        <div id="totalBalance" class="total">Saldo: $0</div>
      </section>

      <!-- Inventario -->
      <div class="card p-4" id="inventarioSection">
        <h3>Inventario</h3>
        <form id="formInventario" class="row g-3 mb-4">
          <div class="col-md-2"><input type="text" id="itemInv" class="form-control" placeholder="Item" required></div>
          <div class="col-md-2"><input type="text" id="codigoInv" class="form-control" placeholder="Código" required></div>
          <div class="col-md-4"><input type="text" id="nombreInv" class="form-control" placeholder="Nombre" required></div>
          <div class="col-md-2"><input type="number" id="unidadesInv" class="form-control" placeholder="Unidades" required></div>
          <div class="col-md-2"><button type="submit" class="btn btn-primary w-100">Agregar Inventario</button></div>
        </form>
        <div class="table-responsive">
          <table class="table table-striped table-bordered text-center">
            <thead class="table-dark">
              <tr>
                <th>Item</th><th>Código</th><th>Nombre</th><th>Ingreso</th><th>Egreso</th><th>Unidades</th><th>Acciones</th>
              </tr>
            </thead>
            <tbody id="inventarioBody"></tbody>
          </table>
        </div>
      </div>

      <!-- Gestión de Mercadería -->
      <div class="card p-4" id="gestionSection">
        <h3>Gestión de Mercadería</h3>
        <form id="formGestion" class="row g-3 mb-4">
          <div class="col-md-3">
            <select id="selProducto" class="form-select" required>
              <option value="" disabled selected>Selecciona Nombre</option>
            </select>
          </div>
          <div class="col-md-2"><input type="number" id="ingresoG" class="form-control" placeholder="Ingreso" readonly></div>
          <div class="col-md-2"><input type="number" step="0.01" id="precioCompraG" class="form-control" placeholder="Costo" required></div>
          <div class="col-md-1"><input type="number" id="ventaG" class="form-control" placeholder="Venta" required></div>
          <div class="col-md-2"><input type="number" step="0.01" id="precioVentaG" class="form-control" placeholder="Precio Venta" required></div>
          <div class="col-md-1"><input type="number" id="saldoG" class="form-control" placeholder="Saldo" readonly></div>
          <div class="col-md-1"><button type="submit" class="btn btn-success w-100">+ Añadir</button></div>
        </form>
        <div class="table-responsive">
          <table class="table table-striped table-bordered text-center">
            <thead class="table-dark">
              <tr>
                <th>#</th><th>Producto</th><th>Ingreso</th><th>Costo</th>
                <th>Venta</th><th>Precio Venta</th><th>Saldo</th>
                <th>Val.1<br><small>Ingreso×Venta</small></th>
                <th>Val.2<br><small>PrecioVenta×Saldo</small></th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody id="gestionBody"></tbody>
          </table>
        </div>
      </div>

    </div>
  </main>

  <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>
  <script>
    // contraseña para gestionar
    const PASSWORD = 'fernandez123';
    let manageMode = false;
    const manageBtn = document.getElementById('manageBtn');
    manageBtn.onclick = () => {
      if (manageMode) {
        manageMode = false;
        manageBtn.textContent = 'Gestionar (editar/eliminar)';
      } else {
        const pass = prompt('Ingrese contraseña:');
        if (pass === PASSWORD) {
          manageMode = true;
          manageBtn.textContent = 'Salir gestionar';
        } else {
          return alert('Contraseña incorrecta');
        }
      }
      renderAll();
    };

    // toggle sidebar
    document.getElementById('hamburgerMenu').onclick = () =>
      document.getElementById('sidebarNav').classList.toggle('show');

    // --- BALANCE ---
    const KEY_INC = 'balance_incomes', KEY_EXP = 'balance_expenses';
    let incomes  = JSON.parse(localStorage.getItem(KEY_INC))  || [];
    let expenses = JSON.parse(localStorage.getItem(KEY_EXP)) || [];
    const totalIncome  = document.getElementById('totalIncome');
    const totalExpense = document.getElementById('totalExpense');
    const totalBalance = document.getElementById('totalBalance');

    function saveBalance() {
      localStorage.setItem(KEY_INC, JSON.stringify(incomes));
      localStorage.setItem(KEY_EXP, JSON.stringify(expenses));
    }
    function renderBalance() {
      // totales
      const ti = incomes.reduce((s,i)=>s+i.amount,0);
      const te = expenses.reduce((s,e)=>s+e.amount,0);
      totalIncome.textContent  = `Total Ingresos: $${ti.toFixed(2)}`;
      totalExpense.textContent = `Total Egresos: $${te.toFixed(2)}`;
      totalBalance.textContent = `Saldo: $${(ti-te).toFixed(2)}`;
    }
    document.getElementById('incomeForm').onsubmit = e => {
      e.preventDefault();
      incomes.push({
        date:   document.getElementById('incomeDate').value,
        concept:document.getElementById('incomeConcept').value,
        docType:document.getElementById('incomeDocType').value,
        method: document.getElementById('incomeMethod').value,
        amount: parseFloat(document.getElementById('incomeAmount').value)
      });
      saveBalance(); renderBalance(); e.target.reset();
    };
    document.getElementById('expenseForm').onsubmit = e => {
      e.preventDefault();
      expenses.push({
        date:   document.getElementById('expenseDate').value,
        concept:document.getElementById('expenseConcept').value,
        amount: parseFloat(document.getElementById('expenseAmount').value)
      });
      saveBalance(); renderBalance(); e.target.reset();
    };

    // --- INVENTARIO ---
    let inventario = JSON.parse(localStorage.getItem('inv')) || [];
    function saveInv(){ localStorage.setItem('inv', JSON.stringify(inventario)); }
    function renderInv(){
      const tbody = document.getElementById('inventarioBody');
      tbody.innerHTML = '';
      inventario.forEach((v,i)=>{
        const ing = incomes.filter(x=>x.concept===v.nombre).reduce((s,x)=>s+x.amount,0);
        const eg  = expenses.filter(x=>x.concept===v.nombre).reduce((s,x)=>s+x.amount,0);
        let row = `<td>${v.item}</td><td>${v.codigo}</td><td>${v.nombre}</td>
          <td>${ing.toFixed(2)}</td><td>${eg.toFixed(2)}</td><td>${v.unidades}</td>`;
        row += manageMode
          ? `<td>
               <button class="btn btn-sm btn-warning edit-btn" onclick="editInv(${i})">✎</button>
               <button class="btn btn-sm btn-danger delete-btn" onclick="delInv(${i})">🗑️</button>
             </td>`
          : `<td></td>`;
        tbody.insertAdjacentHTML('beforeend',`<tr>${row}</tr>`);
      });
    }
    document.getElementById('formInventario').onsubmit = e => {
      e.preventDefault();
      inventario.push({
        item:     document.getElementById('itemInv').value,
        codigo:   document.getElementById('codigoInv').value,
        nombre:   document.getElementById('nombreInv').value,
        unidades: parseInt(document.getElementById('unidadesInv').value,10)
      });
      saveInv(); renderInv(); e.target.reset();
    };
    window.delInv = i => { inventario.splice(i,1); saveInv(); renderInv(); };
    window.editInv = i => {
      const v = inventario.splice(i,1)[0];
      document.getElementById('itemInv').value     = v.item;
      document.getElementById('codigoInv').value   = v.codigo;
      document.getElementById('nombreInv').value   = v.nombre;
      document.getElementById('unidadesInv').value = v.unidades;
      saveInv(); renderInv();
    };

    // --- GESTIÓN DE MERCADERÍA ---
    let gestion = JSON.parse(localStorage.getItem('ges')) || [];
    function saveGes(){ localStorage.setItem('ges', JSON.stringify(gestion)); }
    function refreshSelect(){
      const sel = document.getElementById('selProducto');
      sel.innerHTML = '<option value="" disabled selected>Selecciona Nombre</option>';
      inventario.forEach(v=> sel.innerHTML += `<option>${v.nombre}</option>`);
    }
    document.getElementById('selProducto').onchange = e => {
      const nom = e.target.value;
      document.getElementById('ingresoG').value = incomes
        .filter(x=>x.concept===nom).reduce((s,x)=>s+x.amount,0);
      // nuevo saldo: ingreso - egreso
      const eg = expenses.filter(x=>x.concept===nom).reduce((s,x)=>s+x.amount,0);
      document.getElementById('saldoG').value = (parseFloat(document.getElementById('ingresoG').value) - eg).toFixed(2);
    };
    function renderGes(){
      const tbody = document.getElementById('gestionBody');
      tbody.innerHTML = '';
      gestion.forEach((p,i)=>{
        const v1 = p.ingreso * p.venta;
        const v2 = p.precioVenta * p.saldo;
        let row = `<td>${i+1}</td><td>${p.producto}</td><td>${p.ingreso}</td>
          <td>S/ ${p.precioCompra.toFixed(2)}</td><td>${p.venta}</td>
          <td>S/ ${p.precioVenta.toFixed(2)}</td><td>${p.saldo}</td>
          <td>${v1}</td><td>S/ ${v2.toFixed(2)}</td>`;
        row += manageMode
          ? `<td>
               <button class="btn btn-sm btn-warning edit-btn" onclick="editGes(${i})">✎</button>
               <button class="btn btn-sm btn-danger delete-btn" onclick="delGes(${i})">🗑️</button>
             </td>`
          : `<td></td>`;
        tbody.insertAdjacentHTML('beforeend', `<tr>${row}</tr>`);
      });
    }
    document.getElementById('formGestion').onsubmit = e => {
      e.preventDefault();
      const nom       = document.getElementById('selProducto').value;
      const ventaCant = parseInt(document.getElementById('ventaG').value,10);
      // ingreso acumulado
      const ingresoTotal = incomes.filter(x=>x.concept===nom).reduce((s,x)=>s+x.amount,0);
      // egreso acumulado
      const egTotal = expenses.filter(x=>x.concept===nom).reduce((s,x)=>s+x.amount,0);
      // saldo = ingreso - egreso
      const nuevoSaldo = ingresoTotal - egTotal;

      const p = {
        producto:     nom,
        ingreso:      ingresoTotal,
        precioCompra: parseFloat(document.getElementById('precioCompraG').value),
        venta:        ventaCant,
        precioVenta:  parseFloat(document.getElementById('precioVentaG').value),
        saldo:        parseFloat(nuevoSaldo.toFixed(2))
      };

      gestion.push(p);
      saveGes(); renderGes();
      e.target.reset();
    };
    window.delGes = i => { gestion.splice(i,1); saveGes(); renderGes(); };
    window.editGes = i => {
      const p = gestion.splice(i,1)[0];
      document.getElementById('selProducto').value     = p.producto;
      document.getElementById('ingresoG').value        = p.ingreso;
      document.getElementById('precioCompraG').value   = p.precioCompra;
      document.getElementById('ventaG').value          = p.venta;
      document.getElementById('precioVentaG').value    = p.precioVenta;
      document.getElementById('saldoG').value          = p.saldo;
      saveGes(); renderGes();
    };

    // renderiza todo
    function renderAll(){
      renderBalance();
      renderInv();
      refreshSelect();
      renderGes();
    }
    window.onload = renderAll;
  </script>
</body>
</html>
